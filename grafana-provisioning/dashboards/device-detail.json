{
  "links": [
    {
      "icon": "arrow-left",
      "title": "Back to All Devices",
      "type": "link",
      "url": "/d/e6c247ec-f126-416f-8df1-104802f2c71a/all-network-devices"
    }
  ],
  "panels": [
    {
      "datasource": {
        "type": "influxdb",
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "left",
            "cellOptions": {
              "type": "auto"
            }
          }
        }
      },
      "gridPos": {
        "h": 3,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 1,
      "options": {
        "cellHeight": "sm",
        "footer": {
          "show": false
        },
        "showHeader": true
      },
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "import \"strings\"\nimport \"array\"\n\ndata = from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"bandwidth\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n\nfirst_record = data |> first()\nungrouped_data = data |> group()\n\nip_val = first_record |> findColumn(fn: (key) => true, column: \"ip\")\nmac_val = first_record |> findColumn(fn: (key) => true, column: \"mac\")\nfirst_seen = ungrouped_data |> first() |> findColumn(fn: (key) => true, column: \"_time\")\nlast_seen = ungrouped_data |> last() |> findColumn(fn: (key) => true, column: \"_time\")\nprotocols = data |> distinct(column: \"protocol\") |> findColumn(fn: (key) => true, column: \"protocol\")\n\narray.from(rows: [{\n  \"Device\": \"${device}\",\n  \"IP Address\": if length(arr: ip_val) > 0 then ip_val[0] else \"unknown\",\n  \"MAC Address\": if length(arr: mac_val) > 0 then mac_val[0] else \"unknown\",\n  \"First Seen\": if length(arr: first_seen) > 0 then string(v: first_seen[0]) else \"unknown\",\n  \"Last Seen\": if length(arr: last_seen) > 0 then string(v: last_seen[0]) else \"unknown\",\n  \"Protocols\": strings.joinStr(arr: protocols, v: \", \")\n}])",
          "refId": "A"
        }
      ],
      "title": "Device Information",
      "type": "table"
    },
    {
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "yellow",
                "value": 10000000
              },
              {
                "color": "red",
                "value": 50000000
              }
            ]
          },
          "unit": "bps"
        }
      },
      "gridPos": {
        "h": 6,
        "w": 8,
        "x": 0,
        "y": 4
      },
      "id": 2,
      "options": {
        "colorMode": "background",
        "graphMode": "area"
      },
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"bandwidth\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r.direction == \"rx\")\n  |> drop(columns: [\"_time\"])\n  |> group(columns: [\"device_name\"])\n  |> sum()\n  |> group()\n  |> map(fn: (r) => ({\n      r with\n      _value: float(v: r._value) * 8.0 / (float(v: uint(v: v.timeRangeStop) - uint(v: v.timeRangeStart)) / 1000000000.0)\n    }))",
          "refId": "A"
        }
      ],
      "title": "Average Download Bandwidth",
      "type": "stat"
    },
    {
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "yellow",
                "value": 5000000
              },
              {
                "color": "red",
                "value": 25000000
              }
            ]
          },
          "unit": "bps"
        }
      },
      "gridPos": {
        "h": 6,
        "w": 8,
        "x": 8,
        "y": 4
      },
      "id": 3,
      "options": {
        "colorMode": "background",
        "graphMode": "area"
      },
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"bandwidth\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r.direction == \"tx\")\n  |> drop(columns: [\"_time\"])\n  |> group(columns: [\"device_name\"])\n  |> sum()\n  |> group()\n  |> map(fn: (r) => ({\n      r with\n      _value: float(v: r._value) * 8.0 / (float(v: uint(v: v.timeRangeStop) - uint(v: v.timeRangeStart)) / 1000000000.0)\n    }))",
          "refId": "A"
        }
      ],
      "title": "Average Upload Bandwidth",
      "type": "stat"
    },
    {
      "fieldConfig": {
        "defaults": {
          "decimals": 0,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": 0
              },
              {
                "color": "yellow",
                "value": 500
              },
              {
                "color": "red",
                "value": 2000
              }
            ]
          },
          "unit": "short"
        }
      },
      "gridPos": {
        "h": 6,
        "w": 8,
        "x": 16,
        "y": 4
      },
      "id": 4,
      "options": {
        "colorMode": "background",
        "graphMode": "area"
      },
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"connection_events\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r._field == \"src_port\")\n  |> group(columns: [\"device_name\"])\n  |> aggregateWindow(every: 30s, fn: count, createEmpty: false)\n  |> max()\n  |> group()",
          "refId": "A"
        }
      ],
      "title": "Peak Connections",
      "type": "stat"
    },
    {
      "fieldConfig": {
        "defaults": {
          "custom": {
            "axisPlacement": "auto",
            "drawStyle": "line",
            "fillOpacity": 20,
            "lineInterpolation": "smooth",
            "lineWidth": 2,
            "showPoints": "never"
          },
          "unit": "bps"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 24,
        "x": 0,
        "y": 10
      },
      "id": 5,
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"bandwidth\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r.direction == \"rx\")\n  |> group(columns: [\"device_name\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: sum, createEmpty: false)\n  |> map(fn: (r) => ({\n      _time: r._time,\n      _value: float(v: r._value) * 8.0 / (float(v: uint(v: v.windowPeriod)) / 1000000000.0),\n      direction: \"Download\"\n    }))\n  |> group(columns: [\"direction\"])",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"bandwidth\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r.direction == \"tx\")\n  |> group(columns: [\"device_name\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: sum, createEmpty: false)\n  |> map(fn: (r) => ({\n      _time: r._time,\n      _value: float(v: r._value) * -8.0 / (float(v: uint(v: v.windowPeriod)) / 1000000000.0),\n      direction: \"Upload\"\n    }))\n  |> group(columns: [\"direction\"])",
          "refId": "B"
        }
      ],
      "title": "Bandwidth Over Time",
      "type": "timeseries"
    },
    {
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "fillOpacity": 50,
            "lineInterpolation": "smooth",
            "stacking": {
              "mode": "normal"
            }
          },
          "unit": "short"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 18
      },
      "id": 6,
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"connection_events\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r._field == \"src_port\")\n  |> group(columns: [\"protocol\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: count, createEmpty: false)",
          "refId": "A"
        }
      ],
      "title": "Connections by Protocol",
      "type": "timeseries"
    },
    {
      "fieldConfig": {
        "defaults": {
          "displayName": "${__field.labels.app}",
          "unit": "Bps"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 18
      },
      "id": 7,
      "options": {
        "displayLabels": [
          "percent"
        ],
        "legend": {
          "displayMode": "table",
          "placement": "right",
          "values": [
            "value",
            "percent"
          ]
        },
        "pieType": "pie"
      },
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dpi_flow\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r._field == \"bytes\")\n  |> filter(fn: (r) => r._value > 0)\n  |> group(columns: [\"app\"])\n  |> sum()\n  |> map(fn: (r) => ({\n      _value: float(v: r._value) * 8.0 / (float(v: uint(v: v.timeRangeStop) - uint(v: v.timeRangeStart)) / 1000000000.0),\n      app: r.app\n    }))\n  |> group(columns: [\"app\"])",
          "refId": "A"
        }
      ],
      "title": "Application Bandwidth Distribution",
      "type": "piechart"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "displayName": "${__field.labels.domain}",
          "unit": "short"
        }
      },
      "gridPos": {
        "h": 6,
        "w": 12,
        "x": 0,
        "y": 26
      },
      "id": 8,
      "options": {
        "displayMode": "gradient",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": true
        },
        "showUnfilled": true
      },
      "targets": [
        {
          "datasource": {
            "type": "influxdb",
            "uid": "P951FEA4DE68E13C5"
          },
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"dns_query\" and r._field == \"domain\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> map(fn: (r) => ({r with domain: r._value}))\n  |> group(columns: [\"domain\"])\n  |> count()\n  |> group()\n  |> sort(columns: [\"_value\"], desc: true)\n  |> limit(n: ${top_destinations})",
          "refId": "A"
        }
      ],
      "title": "Top DNS Queries",
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "align": "left",
            "filterable": true
          }
        }
      },
      "gridPos": {
        "h": 12,
        "w": 24,
        "x": 0,
        "y": 32
      },
      "id": 9,
      "options": {
        "showHeader": true,
        "sortBy": [
          {
            "desc": true,
            "displayName": "_time"
          }
        ]
      },
      "targets": [
        {
          "query": "from(bucket: \"network\") |> range(start: v.timeRangeStart, stop: v.timeRangeStop) |> filter(fn: (r) => r._measurement == \"connection_events\") |> filter(fn: (r) => r.device_name == \"${device}\") |> filter(fn: (r) => r._field == \"src_port\") |> group() |> sort(columns: [\"_time\"], desc: true) |> limit(n: 100) |> keep(columns: [\"_time\", \"dst_ip\", \"hostname\", \"dst_port\", \"protocol\"])",
          "refId": "A"
        }
      ],
      "title": "Connection History",
      "type": "table"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "displayName": "${__field.labels.destination}",
          "unit": "short"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 44
      },
      "id": 10,
      "options": {
        "displayMode": "gradient",
        "orientation": "horizontal",
        "reduceOptions": {
          "calcs": [],
          "fields": "",
          "values": true
        },
        "showUnfilled": true
      },
      "targets": [
        {
          "query": "from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"connection_events\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r._field == \"src_port\")\n  |> group(columns: [\"dst_ip\", \"hostname\"])\n  |> count()\n  |> map(fn: (r) => ({\n      r with\n      destination: if exists r.hostname and r.hostname != \"\" and r.hostname != r.dst_ip\n                   then r.hostname\n                   else r.dst_ip\n    }))\n  |> group(columns: [\"destination\"])\n  |> sum()\n  |> group()\n  |> sort(columns: [\"_value\"], desc: true)\n  |> limit(n: ${top_destinations})",
          "refId": "A"
        }
      ],
      "title": "Top Destination IPs",
      "type": "bargauge"
    },
    {
      "datasource": {
        "type": "influxdb",
        "uid": "P951FEA4DE68E13C5"
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 80
          },
          "unit": "short"
        }
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 44
      },
      "id": 11,
      "targets": [
        {
          "query": "// Step 1: Get top N destination IPs by connection count\ntop_dests = from(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"connection_events\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r._field == \"src_port\")\n  |> group(columns: [\"dst_ip\"])\n  |> count()\n  |> group()\n  |> sort(columns: [\"_value\"], desc: true)\n  |> limit(n: ${top_destinations})\n  |> findColumn(fn: (key) => true, column: \"dst_ip\")\n\n// Step 2: Timeseries for top destinations\nfrom(bucket: \"network\")\n  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)\n  |> filter(fn: (r) => r._measurement == \"connection_events\")\n  |> filter(fn: (r) => r.device_name == \"${device}\")\n  |> filter(fn: (r) => r._field == \"src_port\")\n  |> filter(fn: (r) => contains(value: r.dst_ip, set: top_dests))\n  |> map(fn: (r) => ({\n      r with\n      destination: if exists r.hostname and r.hostname != \"\" and r.hostname != r.dst_ip\n                   then r.hostname\n                   else r.dst_ip\n    }))\n  |> group(columns: [\"destination\"])\n  |> aggregateWindow(every: v.windowPeriod, fn: count, createEmpty: false)",
          "refId": "A"
        }
      ],
      "title": "Connection Activity Over Time",
      "type": "timeseries"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "tags": [
    "device",
    "detail",
    "drill-down"
  ],
  "templating": {
    "list": [
      {
        "current": {
          "text": "Macmini",
          "value": "Macmini"
        },
        "datasource": {
          "type": "influxdb",
          "uid": "P951FEA4DE68E13C5"
        },
        "hide": 0,
        "includeAll": false,
        "multi": false,
        "name": "device",
        "query": "import \"influxdata/influxdb/schema\"\n\nschema.tagValues(\n  bucket: \"network\",\n  tag: \"device_name\",\n  predicate: (r) => r._measurement == \"bandwidth\",\n  start: -24h\n)",
        "refresh": 1,
        "regex": "/^(?!GL-iNet_Router.*|Router_DNS|localhost).*/",
        "skipUrlSync": false,
        "sort": 1,
        "type": "query"
      },
      {
        "current": {
          "selected": true,
          "text": "Show Top 20",
          "value": "20"
        },
        "hide": 0,
        "includeAll": false,
        "label": "",
        "multi": false,
        "name": "top_destinations",
        "options": [
          {
            "selected": false,
            "text": "Show Top 5",
            "value": "5"
          },
          {
            "selected": false,
            "text": "Show Top 10",
            "value": "10"
          },
          {
            "selected": false,
            "text": "Show Top 15",
            "value": "15"
          },
          {
            "selected": true,
            "text": "Show Top 20",
            "value": "20"
          },
          {
            "selected": false,
            "text": "Show Top 30",
            "value": "30"
          },
          {
            "selected": false,
            "text": "Show Top 50",
            "value": "50"
          },
          {
            "selected": false,
            "text": "Show Top 100",
            "value": "100"
          }
        ],
        "query": "5,10,15,20,30,50,100",
        "skipUrlSync": false,
        "type": "custom"
      }
    ]
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timezone": "browser",
  "title": "Device Detail",
  "uid": "66bdd5ca-674b-46db-b177-59920156e784",
  "version": 1
}
